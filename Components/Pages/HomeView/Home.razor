@page "/"
@rendermode InteractiveServer
@inject IJSRuntime JS

<PageTitle>Tổng quan</PageTitle>

<div class="page-home-dashboard animate-fade-in">
    <div class="std-card" style="flex: 0 0 auto; padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
        <div class="flex-between">
            <div class="card-title" style="font-size: 1.25rem; margin:0;">
                <div class="tea-icon"><span class="material-icons-round">dashboard</span></div>
                Tổng quan
            </div>

            <div class="action-group">
                <button class="btn btn-primary" @onclick="() => IsCalendarOpen = true">
                    <span class="material-icons-round">calendar_month</span>
                    <span>@SelectedDate.ToString("dd/MM/yyyy")</span>
                    <span class="material-icons-round" style="font-size: 16px;">expand_more</span>
                </button>
            </div>
        </div>
    </div>

    <div class="home-stats-row">
        <div class="stat-card" style="background: var(--grad-blue);">
            <div class="stat-icon-box"><span class="material-icons-round">school</span></div>
            <div class="stat-info"><p class="stat-label">Học sinh</p><p class="stat-value">1384</p></div>
            <div class="blob-1"></div>
        </div>
        <div class="stat-card" style="background: var(--grad-orange);">
            <div class="stat-icon-box"><span class="material-icons-round">person</span></div>
            <div class="stat-info"><p class="stat-label">Giáo viên</p><p class="stat-value">76</p></div>
            <div class="blob-1"></div>
        </div>
        <div class="stat-card" style="background: var(--grad-green);">
            <div class="stat-icon-box"><span class="material-icons-round">apartment</span></div>
            <div class="stat-info"><p class="stat-label">Khối</p><p class="stat-value">5</p></div>
            <div class="blob-1"></div>
        </div>
        <div class="stat-card" style="background: var(--grad-purple);">
            <div class="stat-icon-box"><span class="material-icons-round">domain</span></div>
            <div class="stat-info"><p class="stat-label">Lớp học</p><p class="stat-value">35</p></div>
            <div class="blob-1"></div>
        </div>
    </div>

    <div class="home-main-grid">
        <div class="std-card home-chart-card">
            <div class="card-header">
                <div class="card-title"><div class="bar-indicator" style="background: var(--c-blue)"></div> Thống kê</div>
                <div class="home-chart-tabs">
                    <div class="tab-item @(ChartMode == "Student" ? "active" : "")" @onclick='() => ChangeChartMode("Student")'>Học sinh</div>
                    <div class="tab-item @(ChartMode == "Teacher" ? "active" : "")" @onclick='() => ChangeChartMode("Teacher")'>Giáo viên</div>
                </div>
            </div>
            <div class="home-chart-body flex-center">
                <div class="chart-wrapper">
                    <canvas id="attendancePieChart"></canvas>
                    <div class="chart-center">
                        <span class="c-sub">@(ChartMode == "Student" ? "Học sinh" : "Giáo viên")</span>
                        <span class="c-main">@(ChartMode == "Student" ? "92%" : "98%")</span>
                        <span class="c-sub text-green">Có mặt</span>
                    </div>
                </div>
                <div class="chart-legend">
                    <div class="l-item"><span class="dot bg-green-light" style="background: #10b981;"></span> Có mặt: <b>@(ChartMode == "Student" ? 1280 : 74)</b></div>
                    <div class="l-item"><span class="dot bg-red-light" style="background: #ef4444;"></span> Vắng: <b>@(ChartMode == "Student" ? 104 : 2)</b></div>
                </div>
            </div>
        </div>

        <div class="std-card home-list-card">
            <div class="card-header">
                <div class="card-title"><div class="bar-indicator" style="background: var(--c-green)"></div> Chi tiết</div>
                @if (SelectedGrade != null)
                {
                    <button class="btn-icon" @onclick="BackToOverview"><span class="material-icons-round text-red">keyboard_return</span></button>
                }
            </div>
            <div class="home-list-scroll">
                @if (SelectedGrade == null)
                {
                    @foreach (var item in GradeStats)
                    {
                        <div class="progress-row" @onclick="() => SelectGrade(item)">
                            <div class="grade-icon" style="background: @item.Color;">@item.ShortName</div>
                            <div class="p-content">
                                <div class="flex-between mb-1"><span class="p-name">@item.Name</span><span class="p-val">@item.Present/@item.Total</span></div>
                                <div class="p-bar"><div class="p-fill" style="width: @((double)item.Present / item.Total * 100)%; background: @item.Color;"></div></div>
                            </div>
                            <span class="material-icons-round text-muted">chevron_right</span>
                        </div>
                    }
                }
                else
                {
                    @foreach (var cls in DetailClasses)
                    {
                        <div class="progress-row cursor-default">
                            <div class="grade-icon" style="background: #f1f5f9; color: #333; font-size: 0.65rem;">@cls.ClassName</div>
                            <div class="p-content">
                                <div class="flex-between mb-1"><span class="p-name">Lớp @cls.ClassName</span><span class="p-val">@cls.Present/@cls.Total</span></div>
                                <div class="p-bar"><div class="p-fill" style="width: @((double)cls.Present / cls.Total * 100)%; background: @SelectedGrade.Color;"></div></div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@if (IsCalendarOpen)
{
    <div class="modal-overlay show" @onclick="() => IsCalendarOpen = false">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="flex-between mb-4"><h3 style="margin:0; font-weight:700;">Chọn ngày</h3><span class="material-icons-round cursor-pointer" @onclick="() => IsCalendarOpen = false">close</span></div>
            <div class="flex-between mb-4">
                <span class="material-icons-round cursor-pointer text-primary" @onclick="PrevMonth">chevron_left</span>
                <span style="font-weight:700; color:var(--primary);">Tháng @CurrentDisplayDate.Month, @CurrentDisplayDate.Year</span>
                <span class="material-icons-round cursor-pointer text-primary" @onclick="NextMonth">chevron_right</span>
            </div>
            <div class="calendar-grid">
                <div class="cal-head text-red" style="color:#ef4444;">CN</div><div class="cal-head">T2</div><div class="cal-head">T3</div><div class="cal-head">T4</div><div class="cal-head">T5</div><div class="cal-head">T6</div><div class="cal-head text-red" style="color:#ef4444;">T7</div>
                @foreach (var d in CalendarDays)
                {
                    <div class="cal-cell @(d.Date == SelectedDate.Date ? "active" : "")" @onclick="() => OnDateSelect(d)">@d.Day</div>
                }
            </div>
        </div>
    </div>
}

@code {
    string ChartMode = "Student"; bool IsCalendarOpen = false; DateTime SelectedDate = DateTime.Today; DateTime CurrentDisplayDate = DateTime.Today; List<DateTime> CalendarDays = new List<DateTime>();
    class GradeStat { public string Name { get; set; } public string ShortName { get; set; } public int Total { get; set; } public int Present { get; set; } public string Color { get; set; } }
    class ClassStat { public string ClassName { get; set; } public int Total { get; set; } public int Present { get; set; } }
    GradeStat? SelectedGrade = null; List<ClassStat> DetailClasses = new List<ClassStat>();
    List<GradeStat> GradeStats = new List<GradeStat> {
        new GradeStat { Name="Khối 1", ShortName="K1", Total=350, Present=342, Color="#ef4444" },
        new GradeStat { Name="Khối 2", ShortName="K2", Total=300, Present=285, Color="#f97316" },
        new GradeStat { Name="Khối 3", ShortName="K3", Total=250, Present=248, Color="#eab308" },
        new GradeStat { Name="Khối 4", ShortName="K4", Total=200, Present=195, Color="#22c55e" },
        new GradeStat { Name="Khối 5", ShortName="K5", Total=284, Present=280, Color="#3b82f6" }
    };
    protected override void OnInitialized() { GenerateCalendar(); }
    protected override async Task OnAfterRenderAsync(bool f) { if (f) await UpdateChart(); }
    async Task ChangeChartMode(string m) { ChartMode = m; await UpdateChart(); }
    async Task UpdateChart() { await JS.InvokeVoidAsync("updateAttendanceChart", "attendancePieChart", ChartMode == "Student" ? 1280 : 74, ChartMode == "Student" ? 104 : 2, "Label"); }
    void GenerateCalendar() { CalendarDays.Clear(); var start = new DateTime(CurrentDisplayDate.Year, CurrentDisplayDate.Month, 1); var offset = start.AddDays(-(int)start.DayOfWeek); for (int i = 0; i < 42; i++) CalendarDays.Add(offset.AddDays(i)); }
    void PrevMonth() { CurrentDisplayDate = CurrentDisplayDate.AddMonths(-1); GenerateCalendar(); }
    void NextMonth() { CurrentDisplayDate = CurrentDisplayDate.AddMonths(1); GenerateCalendar(); }
    async Task OnDateSelect(DateTime d) { SelectedDate = d; if (d.Month != CurrentDisplayDate.Month) { CurrentDisplayDate = d; GenerateCalendar(); } await UpdateChart(); IsCalendarOpen = false; }
    void SelectGrade(GradeStat g) { SelectedGrade = g; DetailClasses = Enumerable.Range(1, 8).Select(i => new ClassStat { ClassName = $"{g.ShortName.Replace("K", "")}A{i}", Total = 35, Present = 33 }).ToList(); }
    void BackToOverview() => SelectedGrade = null;
}